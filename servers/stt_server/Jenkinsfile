pipeline {
    agent any
    triggers {
        githubPush()
    }
    environment {
        REGISTRY_NAME = 'tongiservices'
        IMAGE_NAME = 'stt-server'
        TAG = 'latest'
        IMAGE_LOCAL = "${IMAGE_NAME}:${TAG}"
        IMAGE_REMOTE = "${REGISTRY_NAME}.azurecr.io/${IMAGE_NAME}:${TAG}"
    }

    stages {
        stage('Build Docker image') {
            steps {
                dir('servers/stt_server') {
                    sh '''
                        echo "üõ†Ô∏è Building Docker image..."
                        docker build -t ${IMAGE_LOCAL} .
                    '''
                }
            }
        }

        stage('Login to Azure and ACR') {
            steps {
                withCredentials([
                    string(credentialsId: 'azure-client-id', variable: 'AZ_CLIENT_ID'),
                    string(credentialsId: 'azure-client-secret', variable: 'AZ_CLIENT_SECRET'),
                    string(credentialsId: 'azure-tenant-id', variable: 'AZ_TENANT_ID')
                ]) {
                    sh '''
                        echo "üîê Logging in to Azure..."
                        az login --service-principal -u "$AZ_CLIENT_ID" -p "$AZ_CLIENT_SECRET" --tenant "$AZ_TENANT_ID"

                        echo "üîê Logging in to ACR..."
                        az acr login --name ${REGISTRY_NAME}
                    '''
                }
            }
        }

        stage('Tag and Push image') {
            steps {
                sh '''
                    echo "üè∑Ô∏è Tagging image..."
                    docker tag ${IMAGE_LOCAL} ${IMAGE_REMOTE}

                    echo "üöÄ Pushing image to ACR..."
                    docker push ${IMAGE_REMOTE}
                '''
            }
        }
    }

    post {
        success {
            echo "‚úÖ Image pushed successfully to ${REGISTRY_NAME}.azurecr.io!"
        }
        failure {
            echo "‚ùå Failed to push Docker image."
        }
        always {
            sh 'az logout || true'
        }
    }
}
    